name: Generate SSL Certificate

on:
  workflow_dispatch:
    inputs:
      domain_names:
        description: 'Domains to include (comma-separated)'
        required: true
        default: 'myorbisvoice.com,*.myorbisvoice.com'
      email:
        description: 'Email for Let''s Encrypt'
        required: true
        default: 'admin@orbisvoice.app'
      dry_run:
        description: 'Run in dry-run mode (no actual cert issued)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    - cron: '0 0 1 * *'

jobs:
  get-cert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get SSL Certificate
        uses: shibme/cloudflare-letsencrypt-certbot-generate@main
        with:
          cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          domain_names: ${{ github.event.inputs.domain_names || 'myorbisvoice.com,*.myorbisvoice.com' }}
          email: ${{ github.event.inputs.email || 'admin@orbisvoice.app' }}
          cert_file_name: 'orbis_cert'
          dry_run: ${{ github.event.inputs.dry_run || 'false' }}

      - name: Upload Certificate Artifact
        uses: actions/upload-artifact@v4
        with:
          name: orbis-ssl-certificate
          path: orbis_cert.zip

      - name: Copy Certificate to VPS
        uses: appleboy/scp-action@v0.1.7
        # Only run deployment if not dry_run
        if: ${{ github.event.inputs.dry_run == 'false' || github.event_name == 'schedule' }}
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "orbis_cert.zip"
          target: "/opt/orbisvoice/nginx/certs"

      - name: Extract Certificate and Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        if: ${{ github.event.inputs.dry_run == 'false' || github.event_name == 'schedule' }}
        with:
          host: ${{ secrets.VPS_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/orbisvoice/nginx/certs
            apt-get install -y unzip || true
            unzip -o orbis_cert.zip
            rm orbis_cert.zip
            docker restart orbisvoice-nginx-prod
