// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum CommissionLevel {
  LOW
  MED
  HIGH
}

model Tenant {
  id    String     @id @default(cuid())
  name  String
  users User[]
  agents Agent[]
  apiKeys ApiKey[]
  
  // Billing & Subscription fields
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  subscriptionStatus   String?   // active, canceled, past_due, trialing, incomplete
  subscriptionTier     String    @default("starter") // starter, professional, enterprise
  subscriptionEnds     DateTime?
  usageLimit           Int       @default(100) // conversations per month
  usageCount           Int       @default(0)   // current month usage
  usageResetAt         DateTime  @default(now())
  billingEmail         String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  googleConfig TenantGoogleConfig?
  twilioConfig TenantTwilioConfig?
}

model TenantTwilioConfig {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  accountSid String
  authToken  String
  phoneNumber String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id    String     @id @default(cuid())
  tenantId String
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email String @unique
  name  String
  username String? @unique
  passwordHash String?
  isAdmin Boolean @default(false)
  role UserRole @default(USER)
  isBlocked Boolean @default(false)
  avatar String? @db.Text
  
  // Commission settings
  commissionLevel CommissionLevel @default(LOW)
  
  // Google OAuth fields
  googleId String? @unique
  googleEmail String?
  googleName String?
  googleProfilePicture String?
  googleAuthProvider String? // "google"
  
  referralCodeUsed String?
  referralRewardTotal Float @default(0)
  referralsCreated Referral[] @relation("referrer")
  affiliate Affiliate?
  isAffiliate Boolean @default(false)
  rewards RewardTransaction[] @relation("referrer_rewards")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
}

model Agent {
  id    String     @id @default(cuid())
  tenantId String
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name  String
  systemPrompt String
  voiceId String @default("default")
  transcripts Transcript[]
  toolAudits ToolExecutionAudit[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiKey {
  id    String     @id @default(cuid())
  tenantId String
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  key   String @unique
  name  String
  createdAt DateTime @default(now())
  expiresAt DateTime?
}

model Transcript {
  id    String     @id @default(cuid())
  agentId String
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  userId String?
  content String
  duration Int @default(0)
  createdAt DateTime @default(now())
}

model Referral {
  id    String     @id @default(cuid())
  referrerId String
  referrer User @relation("referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  refereeId String?
  code  String @unique
  status String @default("pending") // pending, accepted, completed, expired
  rewardAmount Float @default(10)
  rewardCurrency String @default("USD")
  expiresAt DateTime @default(dbgenerated("now() + interval '90 days'"))
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RewardTransaction {
  id              String           @id @default(cuid())
  referrerId      String
  referrer        User             @relation("referrer_rewards", fields: [referrerId], references: [id], onDelete: Cascade)
  refereeId       String?
  amount          Float
  status          String           @default("pending") // pending, available, paid, refunded
  sourcePaymentId String?          // e.g., Stripe charge ID
  holdEndsAt      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model ToolExecutionAudit {
  id    String     @id @default(cuid())
  agentId String
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  userId String?
  toolName String
  toolInput String // JSON
  toolOutput String? // JSON
  status String @default("pending") // pending, success, failed
  errorMessage String?
  executionTimeMs Int @default(0)
  createdAt DateTime @default(now())
}

model GoogleAuthConfig {
  id String @id @default(cuid())
  clientId String?
  clientSecret String?
  redirectUri String?
  enabled Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TenantGoogleConfig {
  id String @id @default(cuid())
  tenantId String @unique
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId String
  clientSecret String
  geminiApiKey String? // Optional: For AI Studio API
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CalendarCredentials {
  id String @id @default(cuid())
  userId String
  tenantId String
  accessToken String @db.Text
  refreshToken String? @db.Text
  expiresAt DateTime?
  calendarEmail String?
  scope String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId])
}

model GmailCredentials {
  id String @id @default(cuid())
  userId String
  tenantId String
  accessToken String @db.Text
  refreshToken String? @db.Text
  expiresAt DateTime?
  gmailEmail String?
  scope String?
  verified Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId])
}

model PlatformSettings {
  id              String @id @default("global")
  lowCommission   Float  @default(10)
  medCommission   Float  @default(20)
  highCommission  Float  @default(30)
  commissionDurationMonths Int @default(0) // 0 means lifetime
  commissionRateDefault Float @default(30)
  payoutMinimum Float @default(100)
  refundHoldDays Int @default(14)
  starterLimit      Int      @default(1000)
  professionalLimit Int      @default(10000)
  enterpriseLimit   Int      @default(100000)
  ltdLimit          Int      @default(1000)
  aiInfraLimit      Int      @default(250000)
  updatedAt       DateTime @updatedAt
}

enum AffiliateStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum AffiliateReferralStatus {
  PENDING
  CONVERTED
  REJECTED
}

enum PayoutStatus {
  PENDING
  PAID
  CANCELLED
}

model Affiliate {
  id              String           @id @default(cuid())
  userId          String           @unique
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status          AffiliateStatus  @default(PENDING)
  slug            String           @unique
  paymentInfo     String?          @db.Text // Encrypted or JSON string
  payoutEmail     String?          // PayPal or preferred payout email
  totalEarnings   Float            @default(0)
  totalPaid       Float            @default(0)
  balance         Float            @default(0)
  referrals       AffiliateReferral[]
  payouts         AffiliatePayout[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model AffiliateReferral {
  id              String                  @id @default(cuid())
  affiliateId     String
  affiliate       Affiliate               @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  refereeId       String?                 @unique
  status          AffiliateReferralStatus @default(PENDING)
  commissionAmount Float                  @default(0)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
}

model AffiliatePayout {
  id              String           @id @default(cuid())
  affiliateId     String
  affiliate       Affiliate        @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  amount          Float
  status          PayoutStatus     @default(PENDING)
  method          String           @default("stripe") // stripe, paypal, manual
  transactionId   String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}


